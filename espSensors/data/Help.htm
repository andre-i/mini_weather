<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <style>
        table {
           /* width: fit-content; */
            border: solid black 1px;
            border-spacing: 7px 5px; /* Расстояние между границ */
            vertical-align: middle;
        }

        td {
            text-align: center;
        }
        body {background-color: #e0e2e2}
    </style>
</head>
<body>
<h2>Справка по настройке и работе мини метеостанции</h2>
<!--    -->
<h2>Общее описание.</h2>

<div>
    Данная прошивка предназначена для снятия показаний присоединённых к чипу ESP8266 датчиков, записи полученных
    значений в файловую систему и передачи их показаний по сети wifi, если требуется. К чипу присоединяют датчик
    DHT 11 или DHT22 в паре с BMP280. Если возникли сомнения в показаниях температуры, для проверки можно
    присоединить датчик DS18B20 параллельно датчику DHT.
</div>

<div>
    Так же имеется возможность передачи данных сервису <i>Thingspeak.com</i>, последнее только при наличии связи
    с интернет. В прошивке есть возможность просмотра не только текущих значений, но и ранее записанных. Текущие
    значения отображаются в виде показаний измерительных приборов. Записанные в память значения можно увидеть в
    виде графиков за определённый день, месяц или год.
</div>

<h3>Работа чипа</h3>

<div>
<h4>Алгоритм работы.</h4>
<ol>
    <li>
        Сначала производится проверка работы датчиков и режим Wi-Fi. В случае отказов чип переходит в аварийный
        режим. В аварийном режиме в зависимости от вида ошибки либо будет показана страница рабочих параметров с ошибками
	    (неисправны датчики) или присоединённый к модулю светодиод начинает испускать серии импульсов(коды ошибок WiFi). В последовательный
        порт, в этом случае, выводится сообщение об ошибке.
    </li>
    <li>
        <u>В режиме точки доступа(AP)</u> чип сам раздаёт wi-fi. В этом режиме интернет недоступен
        и время приходится устанавливать самостоятельно,иначе теряется смысл записи значений
        датчиков. Если время не установлено, то значения датчиков показываются, но в файл не записываются. В AP режиме
        Thingspeak, соответственно так-же недоступен.
        <br><u>В режиме клиента(STA)</u> сначала происходит опрос даты-времени из интернета, если опрос оказаля
        неудачным, дальнейшая работа чипа будет такой-же как и в режиме точки доступа. В случае удачного опроса
        будет установлено время и показания датчиков будут производиться в файловую систему,хотя данные на Thingspeak.com 
	будут отправляться, но каждый раз неудачно.
        <br><b>Режим работы Wi-Fi определяется по световой сигнализации.</b>
        <br>&nbsp;"Красный" - работает как точка доступа.<br>&nbsp;"Зелёный" - работает как клиент.
    </li>
    <li>
        Сразу после запуска производится запись о старте в журнал. 
    </li>
    <li>
        Далее определяется режим работы обычный или отладка(debug mode). В режиме отладки
        включается вывод отладочнызх сообщений в последовательный порт, каждую минуту происходит опрос датчиков,
        и если требуется, передача данных на Thingspeak. В обычном режиме работы датчики опрашиваются каждые 5 минут
        и передаются данные на Thingspeak, если требуется. Вывода, кроме аварийных сообщений в последовательный порт нет.
    </li>
    <li>
        Когда датчики не опрашиваюся, чип отвечает на запросы клиентов. Клиенты могут обращаться к метеостанции
        через браузер. Адрес метеостанции "weather.local" или просто IP адрес чипа( IP4V стандарт). Часто чип отвечает 
	только по  IP4V адресу. Первые 5 минут чип на запросы клиентов может не отвечать.
        В течении 65 минут после старта недоступно построение графика за последний час, так как час ещё не прошёл
        и на выходе получится мусор.
    </li>
</ol>
</div>
<h4>Параметры старта системы.</h4>
<div>
    При старте чипа, для установки начальных значений некоторых параметров используется файл настроек. Если параметр
    не найден, берётся параметр по умолчнию.
</div>
<ol>
    <li>
        Wi-Fi может работать в двух режимах. Как клиент или точка доступа. Имеются настройки
        для каждого из этих типов соединения.
        <ul>
            <li>
                AP - режим точки доступа. В этом режиме другие устройства присоединяются к точке доступа чипа.
                Соответственно нет соединенитя с интернет и нет возможности получить значеня
                даты и времени. Без даты и времени нет смысла производить запись значений в файл. Сервис
                Thingspeak.com недоступен. Есть доступ к ранее полученным значениям и возможность просматривать 
                текущие значения датчиков. Параметры  AP режима - ssid(имя сети), passwd (пароль).
                ap_ip(адрес точки доступа в соответствии с ip4v).
            </li>
            <li>
                STA - режим клиента. В таком режиме доступ к интернет, такой же как и у ведущей сети. В общем
                случае ведётся запись в файл, есть передача данных на Thingspeak. Параметры - ssid и passwd.
            </li>
        </ul>
        <ul>
            <li><i>Если надо, чтобы модуль работал только как клиент и не мог запуститься как точка доступа есть
                параметр ONLY_STA</i>
            </li>
            <li>
                <i>Для определения состояния соединения с WiFi сетью надо посылать запрос к точке доступа(если у неё
                есть web интерфейс).Для этого есть параметр AP_NETWORK_ADDRESS в котором можно прописать
                адрес сетевого интерфейса точки доступа.</i>
            </li>
        </ul>
        <br>
    </li>
    <li>
        Значение ключа записи на Thingspeak - параметр "thingspeak key". Если не указано, то нет возможности
         отправлять данные на <i>thingspeak.com</i>.
    </li>
    <li>
        Подключение дополнительно датчика DS18B20 - параметр "DS18B20 mode". При значении "true" датчик в работе.
        При остальных датчик не опрашивается.
    </li>
    <li>
        Режим отладки - параметр debug. Может принимать значение "true" в этом случае чип переходит в режим отладки.
        При других значениях отладка отключена.
    </li>
</ol>
<div>
    В случае отсутствия параметра, берётся значение по умолчанию.
    <table>
        <tr><th>Параметр</th><th>Значение</th></tr>
        <tr><td>ONLY_STA</td><td>false</td></tr>
        <tr><td>AP_NETWORK<br>_ADDRESS</td><td>""<br>(пустое значение)</td></tr>
        <tr><td colspan="2"><u> Wi-Fi AP mode </u></td> </tr>
        <tr><td>ssid</td><td>espWeather</td></tr>
        <tr><td>passwd</td><td>espWeather</td></tr>
        <tr><td>ap_ip</td><td>192.168.0.1</td></tr>
        <tr><td colspan="2"><br><hr><u> Wi-Fi STA mode </u></td> </tr>
        <tr><td>ssid</td><td>mywifi</td></tr>
        <tr><td>passwd</td><td>mypasswd</td></tr>
        <tr><td colspan="2"><br><hr><u> Отладка(Debug) </u></td></tr>
        <tr><td>debug</td><td>false</td></tr>
        <tr><td colspan="2"><br><hr><u> Ключ записи Thingpeak </u></td></tr>
        <tr><td>thingpeak key</td><td>значения<br>нет</td></tr>
        <tr><td colspan="2"><br><hr><u> DS18B20 mode </u></td></tr>
        <tr><td>DS18B20 mode</td><td>false</td></tr>
    </table>
</div>

<!--    -->
<h3>Сигнализация</h3>

<div>
    При запуске загораются оба светодиода и светят до создания wifi соединения. Если wifi стартует как клиент -
    остаётся гореть зелёный , если wifi работает как точка доступа остаётся работать красный светодиод.
</div>

<div>
    Если во время запуска возникают проблемы, оба светодиода гаснут. После чего красный светодиод начинает испускать
    серии световых импульсов.
<h4 align="center">Несправности:</h4>
<table align="center">
    <tr border="solid black 2px" >
        <td><b>количество <br>импульсов</b></td>
        <td><b>проблема</b></td>
    </tr>
    <tr><td colspan="2"><hr></td> </tr>
    <tr>
        <td>4</td>
        <td> Wi-Fi не смог запуститься</td>
    </tr>
    <tr>
        <td>5</td>
        <td> Wi-Fi запустился, но нет связи с интернет.</td>
    </tr>
</table>
В аварийном режиме:
<ul>
	<li>Есть связь с чипом по последовательному порту. Он отвечает на команды.</li>
	<li>Если Wi-fi не работает чип перезапустится приблизительно через 10 минут. Это время даётся для изменения настроек
       через последовательный порт.</li>
	<li>Если неисправны датчики - вместо стартовой страницы в браузере отобразится информация о настройках чипа
     и причина неисправности. В таком состоянии модуль может находиться как угодно долго.</li>
</ul>
</div>
<!--    -->
<h3>Справка по UART</h3>

<div>
    Настройка стартовых параметров происходит путём создания файла настроек. Это делается при соединении с модулем по
    последавательному порту(COM, UART, serial). Подробности смотрим в справке. Смотреть справку надо непосредственно
    через последовательный порт модуля. Проще сделать это в ArduinoIDE, запустив SerialMonitor со скоростью 115200
    без символов окончания строк(no line ending) и отправить по нему "ru"(вводим без кавычек).Модуль в ответ пришлёт
    краткую справку по командам и первичной настройке.
<ul><b> &nbsp;&nbsp;Порядок действий:</b>
    <li>Соединить модуль с компьютером через usb-uart адаптер.
    <li>Открыть ArduinoIDE
    <li>запустить "SerialMonitor" в среде ArduinoIDE
    <li>Включить модуль
    <li>Ввести 'ru'
</ul>
</div>


</body>
</hthml>
